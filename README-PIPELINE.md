# 🔄 日報→小話→ブログ自動化パイプライン

障害者専門脱毛サロン「Dupe&more」の日報から小話、ブログまでの自動生成システム

## 📋 システム概要

1. **日報入力** → 管理画面で10項目の詳細日報を入力
2. **小話自動生成** → Claude AIが日報から心温まる小話を作成
3. **ブログ自動生成** → 今日＋前営業日の日報ペアからブログ記事を作成
4. **公開サイト自動更新** → トップページ・ブログページに反映

## 🚀 日常の運用手順

### ✅ 毎日の作業（1日1回・5分）

1. **管理画面にアクセス** → http://localhost:3002
2. **日報管理** → 「新規日報入力」ボタンをクリック
3. **10項目を入力** → 天気、お客様属性、施術内容など
4. **保存** → システムが自動で小話とブログを生成

### 📊 進捗確認（必要時）

1. **パイプライン画面** → http://localhost:3002/admin/pipeline
2. **3つのボード確認**:
   - 📋 日報状況（今日・前営業日）
   - 📖 小話状況（今日・前営業日）
   - 📝 ブログ状況（今日＋前営業日ペア）
3. **❌マークの項目** → 「再生成」ボタンで修復

## 🔧 トラブル対応

### 問題発生時の対処法

| 症状 | 対処法 |
|------|---------|
| 小話が生成されない | パイプライン画面で「小話再生成」ボタン |
| ブログが生成されない | パイプライン画面で「ブログ再生成」ボタン |
| 公開サイトに反映されない | パイプライン画面で「ページ更新」ボタン |
| エラーメッセージが表示 | パイプライン画面下部のエラーログを確認 |

### 再実行の特徴（冪等性）

- **重複防止**: 同じ日付で再実行しても重複しません
- **安全な再試行**: 何度でも「再生成」ボタンを押せます
- **データ保護**: 既存のデータは上書きされません

## 📅 営業日の計算

- **土日・祝日を自動スキップ**
- **金曜→月曜のペアブログ** 自動生成
- **休業日設定**: `admin-panel/config/businessDays.ts` で管理

### 祝日設定例
```typescript
// admin-panel/config/businessDays.ts
export const SALON_SPECIFIC_HOLIDAYS = [
  '2025-06-15', // サロンメンテナンス日
  '2025-12-29', // 年末休業
]
```

## 🧪 テスト・動作確認

### E2Eテスト実行
```bash
# 管理画面を起動してから
cd admin-panel
npm run test
```

### 手動テスト
1. **平日連続テスト**: 木曜→金曜の日報入力
2. **週末跨ぎテスト**: 金曜→月曜の日報入力
3. **冪等性テスト**: 同じ日報を2回入力

## 📦 技術仕様

### データフロー
```
日報入力 → Supabase保存 → Claude API → 小話生成 → Supabase保存
                                    ↓
前営業日の小話あり? → Yes → Claude API → ブログ生成 → 公開サイト更新
                    ↓ No
                  待機状態
```

### データベース構造
- `daily_reports`: 日報データ（10項目）
- `short_stories`: 小話データ（日付ごと1件）
- `blog_posts`: ブログ記事（日付ペアごと1件）
- `agent_logs`: システムログ・エラー追跡

### APIエンドポイント
- `POST /api/daily-reports` → 日報保存＋自動処理
- `POST /api/short-stories/generate` → 小話再生成
- `POST /api/blog-posts/generate` → ブログ再生成
- `POST /api/revalidate` → ページ更新

## 🔒 セキュリティ・運用

### 環境変数（必須）
```env
# admin-panel/.env.local
NEXT_PUBLIC_SUPABASE_URL=https://yaogagvttkpoapkwdrjd.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
ANTHROPIC_API_KEY=[REDACTED]
NEXTAUTH_URL=http://localhost:3002
```

### データ公開範囲
- **一般公開**: `blog_posts.status = 'published'` のみ
- **管理画面**: すべてのデータにアクセス
- **プライバシー保護**: 個人特定情報は小話・ブログから除外

## 📈 今後の拡張予定

1. **日報編集機能** → 既存データの修正・更新
2. **小話管理画面** → 過去の小話一覧・編集
3. **ブログカテゴリ** → テーマ別分類機能
4. **自動公開スケジュール** → 指定時刻での自動公開

---

## 🎯 完成済み機能チェックリスト

- ✅ 日報10項目入力フォーム
- ✅ Claude AI小話自動生成（重複防止）
- ✅ Claude AIブログ自動生成（日付ペア）
- ✅ 営業日自動計算（土日祝スキップ）
- ✅ パイプライン管理ダッシュボード
- ✅ 再実行ボタン（冪等性保証）
- ✅ エラーログ・状態確認
- ✅ 公開サイト自動更新（revalidate）
- ✅ E2Eテスト（平日・週末跨ぎ）
- ✅ データベースRLS設定
- ✅ APIエラーハンドリング

## 📞 サポート・メンテナンス

問題が発生した場合：
1. **パイプライン画面** で状態確認
2. **エラーログ** の内容確認
3. **再生成ボタン** で復旧試行
4. 継続する場合は開発者に連絡

---
*Generated with [Claude Code](https://claude.ai/code) - 日報→小話→ブログ自動化パイプライン完全実装版*